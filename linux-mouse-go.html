<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Dexter Haslem">
    <meta name="description" content="Dexter Haslem - reading linux mouse input with go">

    <link rel="stylesheet" type="text/css" href="./style.css">
    <title>dmh - reading linux mouse input</title>
    <link rel="stylesheet" href="https://media.dmh.fm/hljs/styles/vs.min.css">
    <script src="https://media.dmh.fm/hljs/highlight.min.js"></script>
</head>

<body>

<h1 id="reading-linux-mouse-input-with-golang">Reading linux mouse input with golang</h1>
<p>I think mouse input in linux is generally awful. It always feels terrible in any window manager
and I have begun digging into the whys. It seems mostly related with X adding acceleration.
In my ventures I learned how to read from a mouse device without X. Lets read the mouse input from linux!</p>
<p>In UNIX&#39;y operating systems <a href="https://en.wikipedia.org/wiki/Everything_is_a_file">everything is a file</a> 
which many people seem to enjoy shouting off at irrelevant times with no context. For our purposes,
this means the mouse will be represented as a file somewhere. </p>
<p>If you only have one mouse (why would you have two? freak) you can check <code>/dev/input/mouse0</code></p>
<p><code>$ file /dev/input/mouse0</code></p>
<blockquote>
<p>/dev/input/mouse0: character special (13/32)</p>
</blockquote>
<p>With that we can see the mouse is a so called &#39;special&#39; which is short for a &#39;special file&#39;,
 aka <a href="https://en.wikipedia.org/wiki/Device_file">device file</a></p>
<p>A quick and dirty example in go to get the relative x/y update and whether or not left/right/middle is 
down would look something like this. Note this is blocking and could be drastically better</p>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// TODO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/input.h#n28</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    f, err := os.OpenFile(<span class="hljs-string">"/dev/input/mouse0"</span>, os.O_RDONLY, <span class="hljs-number">0600</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    data := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>,  <span class="hljs-number">3</span>)

    <span class="hljs-keyword">for</span> {
        nr, err := f.Read(data)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            log.Fatal(err)
        }

        <span class="hljs-keyword">if</span> nr == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">break</span>
        }

        left := data[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x1</span> != <span class="hljs-number">0</span>;
        right := data[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x2</span> != <span class="hljs-number">0</span>;
        middle := data[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x4</span> != <span class="hljs-number">0</span>;
        x := <span class="hljs-keyword">int8</span>(data[<span class="hljs-number">1</span>])
        y := <span class="hljs-keyword">int8</span>(data[<span class="hljs-number">2</span>])
        fmt.Printf(<span class="hljs-string">"\r x=%d y=%d left=%v right=%v middle=%v "</span>,
            x, y, left, right, middle)
    }
}
</code></pre>
<p>Assuming you have your <code>GOPATH</code> setup correctly (or use the default of ~/go), save this in a package called eg, 
<code>linux-mouse-events</code>.</p>
<p>Then you can test it like so (CTRL-C to exit):</p>
<pre><code>$ go <span class="hljs-keyword">install</span> linux-mouse-<span class="hljs-keyword">events</span>
$ sudo ~/<span class="hljs-keyword">go</span>/<span class="hljs-keyword">bin</span>/linux-mouse-<span class="hljs-keyword">events</span>
x=<span class="hljs-number">1</span> y=<span class="hljs-number">0</span> <span class="hljs-keyword">left</span>=<span class="hljs-literal">false</span> <span class="hljs-keyword">right</span>=<span class="hljs-literal">false</span> middle=<span class="hljs-literal">false</span> ^C
</code></pre><p>Amazing! Next we will move to timing evdev events to see if anything mucks with raw mouse report rate</p>

    <section class="back-hdr">
        <p><a href="./index.html">..Back to Dexter Haslem home</a></p>
    </section>

</body>

</html>